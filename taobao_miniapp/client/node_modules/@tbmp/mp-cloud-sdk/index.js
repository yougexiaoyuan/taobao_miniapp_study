!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.cloud={})}(this,function(t){"use strict";var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function e(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var p=function(){return(p=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function r(t,e,r,n){var i,o=arguments.length,a=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;0<=s;s--)(i=t[s])&&(a=(o<3?i(a):3<o?i(e,r,a):i(e,r))||a);return 3<o&&a&&Object.defineProperty(e,r,a),a}function d(o,a,s,c){return new(s=s||Promise)(function(t,e){function r(t){try{i(c.next(t))}catch(t){e(t)}}function n(t){try{i(c.throw(t))}catch(t){e(t)}}function i(e){e.done?t(e.value):new s(function(t){t(e.value)}).then(r,n)}i((c=c.apply(o,a||[])).next())})}function O(r,n){var i,o,a,t,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,o&&(a=2&e[0]?o.return:e[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,e[1])).done)return a;switch(o=0,a&&(e=[2&e[0],a.value]),e[0]){case 0:case 1:a=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,o=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!a||e[1]>a[0]&&e[1]<a[3])){s.label=e[1];break}if(6===e[0]&&s.label<a[1]){s.label=a[1],a=e;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(e);break}a[2]&&s.ops.pop(),s.trys.pop();continue}e=n.call(r,s)}catch(t){e=[6,t],o=0}finally{i=a=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}function i(){return function(t,e,r){var l=r.value;r.value=function(t){var e,r=t||{},n=r.success,i=void 0===n?null:n,o=r.fail,a=void 0===o?null:o,s=r.complete,c=void 0===s?null:s,u=!c&&!a&&!i;try{e=l.apply(this,arguments)}catch(t){return u?Promise.reject(t):(a&&a(t),void(c&&c(t)))}if(e=e.then?e:Promise.resolve(e),u)return e;e.then(function(t){i&&i(t),c&&c(t)}).catch(function(t){a&&a(t),c&&c(t)})}}}function M(t,e,r){Array.isArray(e)||(e=e.split("."));var n=e.reduce(function(t,e){return t?t[e]:null},t);return r?n||r:n}function o(t,e){return t(e={exports:{}},e.exports),e.exports}var f,a,s=o(function(t,e){t.exports=function(){var t=t||function(p,r){var n=Object.create||function(){function r(){}return function(t){var e;r.prototype=t;e=new r;r.prototype=null;return e}}();var t={};var e=t.lib={};var i=e.Base=function(){return{extend:function(t){var e=n(this);if(t){e.mixIn(t)}if(!e.hasOwnProperty("init")||this.init===e.init){e.init=function(){e.$super.init.apply(this,arguments)}}e.init.prototype=e;e.$super=this;return e},create:function(){var t=this.extend();t.init.apply(t,arguments);return t},init:function(){},mixIn:function(t){for(var e in t){if(t.hasOwnProperty(e)){this[e]=t[e]}}if(t.hasOwnProperty("toString")){this.toString=t.toString}},clone:function(){return this.init.prototype.extend(this)}}}();var d=e.WordArray=i.extend({init:function(t,e){t=this.words=t||[];if(e!=r){this.sigBytes=e}else{this.sigBytes=t.length*4}},toString:function(t){return(t||a).stringify(this)},concat:function(t){var e=this.words;var r=t.words;var n=this.sigBytes;var i=t.sigBytes;this.clamp();if(n%4){for(var o=0;o<i;o++){var a=r[o>>>2]>>>24-o%4*8&255;e[n+o>>>2]|=a<<24-(n+o)%4*8}}else{for(var o=0;o<i;o+=4){e[n+o>>>2]=r[o>>>2]}}this.sigBytes+=i;return this},clamp:function(){var t=this.words;var e=this.sigBytes;t[e>>>2]&=4294967295<<32-e%4*8;t.length=p.ceil(e/4)},clone:function(){var t=i.clone.call(this);t.words=this.words.slice(0);return t},random:function(t){var e=[];var r=function(e){var e=e;var r=987654321;var n=4294967295;return function(){r=36969*(r&65535)+(r>>16)&n;e=18e3*(e&65535)+(e>>16)&n;var t=(r<<16)+e&n;t/=4294967296;t+=.5;return t*(p.random()>.5?1:-1)}};for(var n=0,i;n<t;n+=4){var o=r((i||p.random())*4294967296);i=o()*987654071;e.push(o()*4294967296|0)}return new d.init(e,t)}});var o=t.enc={};var a=o.Hex={stringify:function(t){var e=t.words;var r=t.sigBytes;var n=[];for(var i=0;i<r;i++){var o=e[i>>>2]>>>24-i%4*8&255;n.push((o>>>4).toString(16));n.push((o&15).toString(16))}return n.join("")},parse:function(t){var e=t.length;var r=[];for(var n=0;n<e;n+=2){r[n>>>3]|=parseInt(t.substr(n,2),16)<<24-n%8*4}return new d.init(r,e/2)}};var s=o.Latin1={stringify:function(t){var e=t.words;var r=t.sigBytes;var n=[];for(var i=0;i<r;i++){var o=e[i>>>2]>>>24-i%4*8&255;n.push(String.fromCharCode(o))}return n.join("")},parse:function(t){var e=t.length;var r=[];for(var n=0;n<e;n++){r[n>>>2]|=(t.charCodeAt(n)&255)<<24-n%4*8}return new d.init(r,e)}};var c=o.Utf8={stringify:function(t){try{return decodeURIComponent(escape(s.stringify(t)))}catch(t){throw new Error("Malformed UTF-8 data")}},parse:function(t){return s.parse(unescape(encodeURIComponent(t)))}};var u=e.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new d.init;this._nDataBytes=0},_append:function(t){if(typeof t=="string"){t=c.parse(t)}this._data.concat(t);this._nDataBytes+=t.sigBytes},_process:function(t){var e=this._data;var r=e.words;var n=e.sigBytes;var i=this.blockSize;var o=i*4;var a=n/o;if(t){a=p.ceil(a)}else{a=p.max((a|0)-this._minBufferSize,0)}var s=a*i;var c=p.min(s*4,n);if(s){for(var u=0;u<s;u+=i){this._doProcessBlock(r,u)}var l=r.splice(0,s);e.sigBytes-=c}return new d.init(l,c)},clone:function(){var t=i.clone.call(this);t._data=this._data.clone();return t},_minBufferSize:0});var l=e.Hasher=u.extend({cfg:i.extend(),init:function(t){this.cfg=this.cfg.extend(t);this.reset()},reset:function(){u.reset.call(this);this._doReset()},update:function(t){this._append(t);this._process();return this},finalize:function(t){if(t){this._append(t)}var e=this._doFinalize();return e},blockSize:512/32,_createHelper:function(r){return function(t,e){return new r.init(e).finalize(t)}},_createHmacHelper:function(r){return function(t,e){return new f.HMAC.init(r,e).finalize(t)}}});var f=t.algo={};return t}(Math);return t}()}),c=(o(function(t,e){t.exports=function(c){return function(i){var t=c,e=t.lib,r=e.WordArray,n=e.Hasher,o=t.algo,a=[],w=[];!function(){function t(t){for(var e=i.sqrt(t),r=2;r<=e;r++)if(!(t%r))return!1;return!0}function e(t){return 4294967296*(t-(0|t))|0}for(var r=2,n=0;n<64;)t(r)&&(n<8&&(a[n]=e(i.pow(r,.5))),w[n]=e(i.pow(r,1/3)),n++),r++}();var b=[],s=o.SHA256=n.extend({_doReset:function(){this._hash=new r.init(a.slice(0))},_doProcessBlock:function(t,e){for(var r=this._hash.words,n=r[0],i=r[1],o=r[2],a=r[3],s=r[4],c=r[5],u=r[6],l=r[7],p=0;p<64;p++){if(p<16)b[p]=0|t[e+p];else{var d=b[p-15],f=(d<<25|d>>>7)^(d<<14|d>>>18)^d>>>3,h=b[p-2],v=(h<<15|h>>>17)^(h<<13|h>>>19)^h>>>10;b[p]=f+b[p-7]+v+b[p-16]}var y=n&i^n&o^i&o,m=(n<<30|n>>>2)^(n<<19|n>>>13)^(n<<10|n>>>22),g=l+((s<<26|s>>>6)^(s<<21|s>>>11)^(s<<7|s>>>25))+(s&c^~s&u)+w[p]+b[p];l=u,u=c,c=s,s=a+g|0,a=o,o=i,i=n,n=g+(m+y)|0}r[0]=r[0]+n|0,r[1]=r[1]+i|0,r[2]=r[2]+o|0,r[3]=r[3]+a|0,r[4]=r[4]+s|0,r[5]=r[5]+c|0,r[6]=r[6]+u|0,r[7]=r[7]+l|0},_doFinalize:function(){var t=this._data,e=t.words,r=8*this._nDataBytes,n=8*t.sigBytes;return e[n>>>5]|=128<<24-n%32,e[14+(64+n>>>9<<4)]=i.floor(r/4294967296),e[15+(64+n>>>9<<4)]=r,t.sigBytes=4*e.length,this._process(),this._hash},clone:function(){var t=n.clone.call(this);return t._hash=this._hash.clone(),t}});t.SHA256=n._createHelper(s),t.HmacSHA256=n._createHmacHelper(s)}(Math),c.SHA256}(s)}),o(function(t,e){t.exports=function(a){(function(){var t=a;var e=t.lib;var r=e.Base;var n=t.enc;var u=n.Utf8;var i=t.algo;var o=i.HMAC=r.extend({init:function(t,e){t=this._hasher=new t.init;if(typeof e=="string"){e=u.parse(e)}var r=t.blockSize;var n=r*4;if(e.sigBytes>n){e=t.finalize(e)}e.clamp();var i=this._oKey=e.clone();var o=this._iKey=e.clone();var a=i.words;var s=o.words;for(var c=0;c<r;c++){a[c]^=1549556828;s[c]^=909522486}i.sigBytes=o.sigBytes=n;this.reset()},reset:function(){var t=this._hasher;t.reset();t.update(this._iKey)},update:function(t){this._hasher.update(t);return this},finalize:function(t){var e=this._hasher;var r=e.finalize(t);e.reset();var n=e.finalize(this._oKey.clone().concat(r));return n}})})()}(s)}),o(function(t,e){t.exports=function(t){return t.HmacSHA256}(s)})),u=o(function(t,e){t.exports=function(e){return function(){var t=e,c=t.lib.WordArray;t.enc.Base64={stringify:function(t){var e=t.words,r=t.sigBytes,n=this._map;t.clamp();for(var i=[],o=0;o<r;o+=3)for(var a=(e[o>>>2]>>>24-o%4*8&255)<<16|(e[o+1>>>2]>>>24-(o+1)%4*8&255)<<8|e[o+2>>>2]>>>24-(o+2)%4*8&255,s=0;s<4&&o+.75*s<r;s++)i.push(n.charAt(a>>>6*(3-s)&63));var c=n.charAt(64);if(c)for(;i.length%4;)i.push(c);return i.join("")},parse:function(t){var e=t.length,r=this._map,n=this._reverseMap;if(!n){n=this._reverseMap=[];for(var i=0;i<r.length;i++)n[r.charCodeAt(i)]=i}var o=r.charAt(64);if(o){var a=t.indexOf(o);-1!==a&&(e=a)}return function(t,e,r){for(var n=[],i=0,o=0;o<e;o++)if(o%4){var a=r[t.charCodeAt(o-1)]<<o%4*2,s=r[t.charCodeAt(o)]>>>6-o%4*2;n[i>>>2]|=(a|s)<<24-i%4*8,i++}return c.create(n,i)}(t,e,n)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),e.enc.Base64}(s)}),l=o(function(t,e){t.exports=function(a){return function(l){var t=a,e=t.lib,r=e.WordArray,n=e.Hasher,i=t.algo,k=[];!function(){for(var t=0;t<64;t++)k[t]=4294967296*l.abs(l.sin(t+1))|0}();var o=i.MD5=n.extend({_doReset:function(){this._hash=new r.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(t,e){for(var r=0;r<16;r++){var n=e+r,i=t[n];t[n]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8)}var o=this._hash.words,a=t[e+0],s=t[e+1],c=t[e+2],u=t[e+3],l=t[e+4],p=t[e+5],d=t[e+6],f=t[e+7],h=t[e+8],v=t[e+9],y=t[e+10],m=t[e+11],g=t[e+12],w=t[e+13],b=t[e+14],_=t[e+15],A=o[0],x=o[1],q=o[2],R=o[3];A=S(A,x,q,R,a,7,k[0]),R=S(R,A,x,q,s,12,k[1]),q=S(q,R,A,x,c,17,k[2]),x=S(x,q,R,A,u,22,k[3]),A=S(A,x,q,R,l,7,k[4]),R=S(R,A,x,q,p,12,k[5]),q=S(q,R,A,x,d,17,k[6]),x=S(x,q,R,A,f,22,k[7]),A=S(A,x,q,R,h,7,k[8]),R=S(R,A,x,q,v,12,k[9]),q=S(q,R,A,x,y,17,k[10]),x=S(x,q,R,A,m,22,k[11]),A=S(A,x,q,R,g,7,k[12]),R=S(R,A,x,q,w,12,k[13]),q=S(q,R,A,x,b,17,k[14]),A=T(A,x=S(x,q,R,A,_,22,k[15]),q,R,s,5,k[16]),R=T(R,A,x,q,d,9,k[17]),q=T(q,R,A,x,m,14,k[18]),x=T(x,q,R,A,a,20,k[19]),A=T(A,x,q,R,p,5,k[20]),R=T(R,A,x,q,y,9,k[21]),q=T(q,R,A,x,_,14,k[22]),x=T(x,q,R,A,l,20,k[23]),A=T(A,x,q,R,v,5,k[24]),R=T(R,A,x,q,b,9,k[25]),q=T(q,R,A,x,u,14,k[26]),x=T(x,q,R,A,h,20,k[27]),A=T(A,x,q,R,w,5,k[28]),R=T(R,A,x,q,c,9,k[29]),q=T(q,R,A,x,f,14,k[30]),A=O(A,x=T(x,q,R,A,g,20,k[31]),q,R,p,4,k[32]),R=O(R,A,x,q,h,11,k[33]),q=O(q,R,A,x,m,16,k[34]),x=O(x,q,R,A,b,23,k[35]),A=O(A,x,q,R,s,4,k[36]),R=O(R,A,x,q,l,11,k[37]),q=O(q,R,A,x,f,16,k[38]),x=O(x,q,R,A,y,23,k[39]),A=O(A,x,q,R,w,4,k[40]),R=O(R,A,x,q,a,11,k[41]),q=O(q,R,A,x,u,16,k[42]),x=O(x,q,R,A,d,23,k[43]),A=O(A,x,q,R,v,4,k[44]),R=O(R,A,x,q,g,11,k[45]),q=O(q,R,A,x,_,16,k[46]),A=M(A,x=O(x,q,R,A,c,23,k[47]),q,R,a,6,k[48]),R=M(R,A,x,q,f,10,k[49]),q=M(q,R,A,x,b,15,k[50]),x=M(x,q,R,A,p,21,k[51]),A=M(A,x,q,R,g,6,k[52]),R=M(R,A,x,q,u,10,k[53]),q=M(q,R,A,x,y,15,k[54]),x=M(x,q,R,A,s,21,k[55]),A=M(A,x,q,R,h,6,k[56]),R=M(R,A,x,q,_,10,k[57]),q=M(q,R,A,x,d,15,k[58]),x=M(x,q,R,A,w,21,k[59]),A=M(A,x,q,R,l,6,k[60]),R=M(R,A,x,q,m,10,k[61]),q=M(q,R,A,x,c,15,k[62]),x=M(x,q,R,A,v,21,k[63]),o[0]=o[0]+A|0,o[1]=o[1]+x|0,o[2]=o[2]+q|0,o[3]=o[3]+R|0},_doFinalize:function(){var t=this._data,e=t.words,r=8*this._nDataBytes,n=8*t.sigBytes;e[n>>>5]|=128<<24-n%32;var i=l.floor(r/4294967296),o=r;e[15+(64+n>>>9<<4)]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8),e[14+(64+n>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),t.sigBytes=4*(e.length+1),this._process();for(var a=this._hash,s=a.words,c=0;c<4;c++){var u=s[c];s[c]=16711935&(u<<8|u>>>24)|4278255360&(u<<24|u>>>8)}return a},clone:function(){var t=n.clone.call(this);return t._hash=this._hash.clone(),t}});function S(t,e,r,n,i,o,a){var s=t+(e&r|~e&n)+i+a;return(s<<o|s>>>32-o)+e}function T(t,e,r,n,i,o,a){var s=t+(e&n|r&~n)+i+a;return(s<<o|s>>>32-o)+e}function O(t,e,r,n,i,o,a){var s=t+(e^r^n)+i+a;return(s<<o|s>>>32-o)+e}function M(t,e,r,n,i,o,a){var s=t+(r^(e|~n))+i+a;return(s<<o|s>>>32-o)+e}t.MD5=n._createHelper(o),t.HmacMD5=n._createHmacHelper(o)}(Math),a.MD5}(s)});(a=f=f||{})[a.MTOP=1]="MTOP",a[a.MY=2]="MY",a[a.GATEWAY=3]="GATEWAY";var h,v=(e(y,h=Error),y);function y(){return null!==h&&h.apply(this,arguments)||this}function m(t){this.options=t||{},this.options.dataProxyGatewayUrl=this.options.dataProxyGatewayUrl||this.options.gatewayUrl}var g=(w.prototype.init=function(e,r){return d(this,void 0,void 0,function(){return O(this,function(t){switch(t.label){case 0:return this.options=p({},e),this.proxy=r,this.tasks=[],this.inited=!0,[4,this.listenNetworkChange()];case 1:return t.sent(),this.flushGatewayRequestQueue(),this.pauseExecTask=!1,[2]}})})},w.prototype.listenNetworkChange=function(){return d(this,void 0,void 0,function(){var e,r=this;return O(this,function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,this.exec({url:"my.getNetworkType"})];case 1:return e=t.sent(),this.networkType=e.networkType,window.my&&window.my.onNetworkStatusChange&&window.my.onNetworkStatusChange(function(t){t&&t.networkType&&(r.networkType=t.networkType)}),[3,3];case 2:return t.sent(),[3,3];case 3:return[2]}})})},w.getRequestType=function(t){return 0===t.indexOf("mtop.")?f.MTOP:0===t.indexOf("my.")?f.MY:f.GATEWAY},w.prototype.verifyResponse=function(e,r,n){return d(this,void 0,void 0,function(){return O(this,function(t){switch(t.label){case 0:if(M(n,"mc-code")||M(e,"errCode")||M(e,"error_response.code"),r.__is_retry_task__)return this.tryThrowError(e,n),[2,e];t.label=1;case 1:return t.trys.push([1,3,,4]),this.tryThrowError(e,n),[2,e];case 2:return[2,t.sent()];case 3:throw t.sent();case 4:return[2]}})})},w.prototype.tryThrowError=function(t,e){var r=M(e,"mc-msg")||M(t,"errMsg")||M(t,"error_response.msg"),n=M(e,"mc-code")||M(t,"errCode")||M(t,"error_response.code");if(n&&"200"!=n){var i=new v(n+":::"+r);throw i.code=n,i.msg=r,i}},w.prototype.sendGatewayRequest=function(n){return d(this,void 0,void 0,function(){var e,r=this;return O(this,function(t){switch(t.label){case 0:return this.pauseExecTask?[2,new Promise(function(t,e){r.tasks.push({detail:n,success:t,fail:e})})]:[3,1];case 1:return n=this.createGatewayRequest(n),[4,this.proxy.apply(p({},n),f.GATEWAY)];case 2:return e=t.sent(),[4,this.verifyResponse(M(e,"data"),n,M(e,"headers"))];case 3:return[2,t.sent()]}})})},w.prototype.flushGatewayRequestQueue=function(i){var o=this;void 0===i&&(i=!1),this.tasks.forEach(function(t){var e=t.detail,r=t.success,n=t.fail;if(i)return n("初始化失败");o.exec(e,f.GATEWAY).then(r).catch(n)}),this.tasks=[]},w.prototype.exec=function(e,r){return d(this,void 0,void 0,function(){return O(this,function(t){switch(t.label){case 0:if(r=r||w.getRequestType(e.url),!this.inited)throw new Error("请先调用cloud.init()");return r!==f.GATEWAY?[3,2]:[4,this.sendGatewayRequest(e)];case 1:return[2,t.sent()];case 2:return[4,this.proxy.apply(e,r)];case 3:return[2,t.sent()]}})})},w.prototype.getHttpRequestSign=function(t,e,r,n,i){if(this.options.signSecret){var o=i;delete n["mc-sign"];var a=e+"\n"+u.stringify(l(o))+"\napplication/json\n"+Object.keys(n).filter(function(t){return/^mc-/.test(t)}).sort().map(function(t){return t.toLowerCase()+":"+n[t]}).join("\n")+"\n"+t+(r?"?"+r:"");return u.stringify(c(a,this.options.signSecret))}},w.prototype.createGatewayRequest=function(t){var e=this.options,r=e.sessionKey,n=e.appKey,i=e.requestId,o=e.miniappId,a=e.openId,s=e.unionId,c=e.cloudId;t.method="POST";var u=p(p({},t.headers),{"Content-Type":"application/json","mc-timestamp":""+Date.now(),"mc-session":r});a&&(u["mc-open-id"]=a),c&&(u["mc-cloud-id"]=c),s&&(u["mc-union-id"]=s),n&&(u["mc-appKey"]=n),o&&(u["mc-miniapp-id"]=o),i&&(u["mc-request-id"]=i),t.env&&(u["mc-env"]=t.env),this.networkType&&(u["mc-network"]=this.networkType),u["mc-session"]||delete u["mc-session"],t.rawData=t.rawData||t.data,"object"==typeof t.data&&(t.data=JSON.stringify(t.data));var l=this.getHttpRequestSign(t.url,t.method,"",u,t.data);return p(p({},t),{url:""+t.url,headers:p(p({},u),{sign:l,"eagleeye-traceid":i})})},w);function w(){this.inited=!1,this.pauseExecTask=!1}function b(t,e){this.request=e,this.options=t}new g;var _,A=(e(x,_=b),x.prototype.invoke=function(e,r,n){return void 0===n&&(n="main"),d(this,void 0,void 0,function(){return O(this,function(t){switch(t.label){case 0:return[4,this.fcRequest({fcName:e,handler:n,data:r})];case 1:return[2,t.sent()]}})})},x.prototype.fcRequest=function(e){return d(this,void 0,void 0,function(){return O(this,function(t){switch(t.label){case 0:return[4,this.request.exec({env:this.options.env||"online",url:"fc",data:e},f.GATEWAY)];case 1:return[2,t.sent()]}})})},r([i()],x.prototype,"invoke",null),x);function x(){return null!==_&&_.apply(this,arguments)||this}var q,E="mtop.taobao.miniapp.cloud.store.config.get",I="mtop.taobao.miniapp.cloud.store.file.save",R="mtop.taobao.miniapp.cloud.store.file.delete",k="mtop.taobao.miniapp.cloud.store.file.list",P="other",S=(e(T,q=b),T.prototype.parseUploadResult=function(t,e,r){return"post"===t?this.parsePostUploadResult(e,r):this.parseAusUploadResult(e,r)},T.prototype.parsePostUploadResult=function(t,e){var r,n,i;try{var o=JSON.parse(e.data);switch(t){case"image":i=o.jsonData.fileId,n=o.jsonData.url;break;case"video":i=o.fileId,r=o.videoId;break;case"audio":i=o.fileId,r=o.videoId}}catch(t){}return{imageUrl:n,originAudioUrl:void 0,specialId:i,videoId:r}},T.prototype.parseAusUploadResult=function(t,e){var r,n,i,o,a=JSON.parse(M(e,["header","x-arup-biz-ret"],"{}"));switch(o=M(a,"mediaCloudFileId"),t){case"image":n=M(e,["header","x-arup-file-url"]);break;case"audio":r=JSON.parse(M(e,"header.x-arup-biz-ret","{}")).videoId,i=M(e,["header","x-arup-file-url"]);break;case"video":r=JSON.parse(M(e,"header.x-arup-biz-ret","{}")).videoId}return{imageUrl:n,originAudioUrl:i,specialId:o,videoId:r}},T.prototype.uploadFile=function(T){return d(this,void 0,void 0,function(){var e,r,n,i,o,a,s,c,u,l,p,d,f,h,v,y,m,g,w,b,_,A,x,q,R,k,S;return O(this,function(t){switch(t.label){case 0:e=T.filePath,r=T.fileType,n=void 0===r?P:r,i=T.fileName,o=void 0===i?"miniappfile":i,t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.storageRequest(E,{newContainer:!0,cloudPath:o,fileType:n})];case 2:return a=t.sent(),[3,4];case 3:throw s=t.sent(),new Error("获取配置错误"+(s.message||s.toString()));case 4:return c=M(a,["data","model",n],{}),u=c.url,l=void 0===u?"":u,p=c.formData,d=void 0===p?null:p,f=c.headers,h=void 0===f?null:f,v=c.method,y=void 0===v?"post":v,(m={url:l,fileType:n,header:h,formData:d,filePath:e,fileName:"file"}).header||delete m.header,m.formData||delete m.formData,"audio"===n&&(m.header=m.header||{}),"other"===n&&(g=m.formData,w={policy:g.policy,signature:g.signature,key:g.key,OSSAccessKeyId:g.OSSAccessKeyId,ossBucket:g.ossBucket,success_action_status:"200"},m.formData=w),[4,this.storageRequest("my.uploadFile",m)];case 5:return b=t.sent(),_=this.parseUploadResult(y,n,b),A=_.imageUrl,x=_.videoId,q=_.originAudioUrl,R=_.specialId,k={fileType:n,specialId:"other"===n?M(a,["data","model",n,"formData","key"],""):R,videoId:x,url:A||q,cloudPath:o},[4,this.storageRequest(I,k)];case 6:if(!M(S=t.sent(),"data.model.url"))throw new Error(M(S,["result","msgInfo"],"上传失败"));return[2,M(S,"data.model")]}})})},T.prototype.deleteFile=function(a){return d(this,void 0,void 0,function(){var e,r,n,i,o;return O(this,function(t){switch(t.label){case 0:return e=a.fileId,r=a.fileType,n=void 0===r?P:r,i=Array.isArray(e)?e:[e],i=JSON.stringify(i),[4,this.storageRequest(R,{fileType:n,fileIds:i})];case 1:if(M(o=t.sent(),["data","model"]))return[2,!0];throw new Error(M(o,["data","msgInfo"]))}})})},T.prototype.getTempFileURL=function(o){return d(this,void 0,void 0,function(){var e,r,n,i;return O(this,function(t){switch(t.label){case 0:if(!(e=o.fileId))throw new Error("缺少fileId,请检查参数");return r=Array.isArray(e)?e:[e],r=JSON.stringify(r),[4,this.storageRequest(k,{fileIds:r})];case 1:if(n=t.sent(),i=M(n,["data","model"]))return[2,i];throw new Error(M(n,["data","msgInfo"]))}})})},T.prototype.storageRequest=function(r,n,i){return d(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e="test"===this.options.env?"test":"online",(n=n||{}).env=e,[4,this.request.exec({url:r,data:n},i)];case 1:return[2,t.sent()]}})})},r([i()],T.prototype,"uploadFile",null),r([i()],T.prototype,"deleteFile",null),r([i()],T.prototype,"getTempFileURL",null),T);function T(){return null!==q&&q.apply(this,arguments)||this}var B=(Object.defineProperty(H.prototype,"name",{get:function(){return this._coll},enumerable:!0,configurable:!0}),H.prototype.aggregate=function(r){return d(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return Array.isArray(r)||(r=[r]),e={aggregate_pipelines:r,collection_name:this._coll},[4,this._db.dbRequest("miniapp.cloud.db.collection.aggregate",e)];case 1:return[2,t.sent()]}})})},H.prototype.count=function(r){return d(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e={filter:r,collection_name:this._coll},[4,this._db.dbRequest("miniapp.cloud.db.collection.count",e)];case 1:return[2,t.sent()]}})})},H.prototype.deleteMany=function(r){return d(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e={filter:r,collection_name:this._coll},[4,this._db.dbRequest("miniapp.cloud.db.collection.remove",e)];case 1:return[2,t.sent()]}})})},H.prototype.find=function(r,n){return void 0===n&&(n={}),d(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e={displayed_fields:n.projection,order_by:n.sort,skip:n.skip,limit:n.limit,filter:r,collection_name:this._coll},[4,this._db.dbRequest("miniapp.cloud.db.collection.get",e)];case 1:return[2,t.sent()]}})})},H.prototype.replaceOne=function(r,n){return d(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e={filter:r,new_record:n,collection_name:this._coll},[4,this._db.dbRequest("miniapp.cloud.db.collection.replace",e)];case 1:return[2,t.sent()]}})})},H.prototype.insertOne=function(r){return d(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e={record:r,collection_name:this._coll},[4,this._db.dbRequest("miniapp.cloud.db.collection.add",e)];case 1:return[2,t.sent()]}})})},H.prototype.insertMany=function(r){return d(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:if(e={records:r,collection_name:this._coll},!Array.isArray(r))throw new Error("带插入的数据只能为数组");return[4,this._db.dbRequest("miniapp.cloud.db.collection.addMany",e)];case 1:return[2,t.sent()]}})})},H.prototype.updateMany=function(r,n,i){return d(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e={filter:r,action:n,arrayFilters:i,collection_name:this._coll},[4,this._db.dbRequest("miniapp.cloud.db.collection.update",e)];case 1:return[2,t.sent()]}})})},H.prototype.createIndex=function(r,n,i){return d(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e={index_name:r,unique:n,fields:i,collection_name:this._coll},[4,this._db.dbRequest("miniapp.cloud.db.index.create",e)];case 1:return[2,t.sent()]}})})},r([i()],H.prototype,"aggregate",null),r([i()],H.prototype,"count",null),r([i()],H.prototype,"deleteMany",null),r([i()],H.prototype,"find",null),r([i()],H.prototype,"replaceOne",null),r([i()],H.prototype,"insertOne",null),r([i()],H.prototype,"insertMany",null),r([i()],H.prototype,"updateMany",null),r([i()],H.prototype,"createIndex",null),H);function H(t,e){this._db=t,this._coll=e}var C,D=(e(j,C=b),j.prototype.collection=function(t){if(!t)throw new Error("集合名称不能为空");return new B(this,t)},j.prototype.createCollection=function(r,t){return d(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return e={collection_name:r},[4,this.dbRequest("miniapp.cloud.db.collection.create",e)];case 1:return[2,t.sent()]}})})},j.prototype.dbRequest=function(r,n){return d(this,void 0,void 0,function(){var e;return O(this,function(t){switch(t.label){case 0:return"test"!==(e=this.options.env)&&(e="online"),n=p(p({},n),{env:e}),[4,this.request.exec({env:e,url:"db/"+r,data:n},f.GATEWAY)];case 1:return[2,t.sent()]}})})},r([i()],j.prototype,"createCollection",null),j);function j(){return null!==C&&C.apply(this,arguments)||this}var U,G=(e(N,U=b),N.prototype.invoke=function(c){return d(this,void 0,void 0,function(){var e,r,n,i,o,a,s;return O(this,function(t){switch(t.label){case 0:return e=c.data,r=c.headers,n=c.authScope,i=c.api,e=e||{},Object.keys(e).forEach(function(t){e[t]="string"==typeof e[t]?e[t]:JSON.stringify(e[t])}),o={apiName:i,httpHeaders:r,data:e},[4,this.topRequest(o)];case 1:if(!M(a=t.sent(),"error_response"))return[2,a];if(26!==(s=M(a,"error_response.code"))&&27!==s||!n)return[3,7];t.label=2;case 2:return t.trys.push([2,6,,7]),[4,function(r,n,i){return r?(n=n||{},new Promise(function(t,e){r.call(i||my,p(p({},n),{success:t,fail:e}))})):Promise.reject("未实现my.api")}(my.authorize,{scopes:n})];case 3:return[4,t.sent()];case 4:return t.sent(),[4,this.topRequest(o)];case 5:return M(a=t.sent(),"error_response")?[3,7]:[2,a];case 6:return t.sent(),[3,7];case 7:throw new Error(""+JSON.stringify(M(a,"error_response")))}})})},N.prototype.topRequest=function(e){return d(this,void 0,void 0,function(){return O(this,function(t){switch(t.label){case 0:return[4,this.request.exec({env:this.options.env||"online",url:"top",data:e},f.GATEWAY)];case 1:return[2,t.sent()]}})})},r([i()],N.prototype,"invoke",null),N);function N(){return null!==U&&U.apply(this,arguments)||this}var z,W=(e(Y,z=b),Y.prototype.invoke=function(i){return d(this,void 0,void 0,function(){var e,r,n;return O(this,function(t){switch(t.label){case 0:return e=i.data,r=i.headers,n=i.api,[4,this.topRequest({apiName:n,httpHeaders:r,data:e})];case 1:return[2,t.sent()]}})})},Y.prototype.topRequest=function(e){return d(this,void 0,void 0,function(){return O(this,function(t){switch(t.label){case 0:return[4,this.request.exec({url:"process",data:e},f.GATEWAY)];case 1:return[2,t.sent()]}})})},r([i()],Y.prototype,"invoke",null),Y);function Y(){return null!==z&&z.apply(this,arguments)||this}var F,J=(e(K,F=b),K.prototype.invoke=function(o){return d(this,void 0,void 0,function(){var e,r,n,i;return O(this,function(t){switch(t.label){case 0:return e=o.data,r=o.headers,n=o.api,i=o.targetAppKey,[4,this.qimenRequest({apiName:n,httpHeaders:r,targetAppKey:i,data:e})];case 1:return[2,t.sent()]}})})},K.prototype.qimenRequest=function(e){return d(this,void 0,void 0,function(){return O(this,function(t){switch(t.label){case 0:return[4,this.request.exec({env:this.options.env||"online",url:"qimen",data:e},f.GATEWAY)];case 1:return[2,t.sent()]}})})},r([i()],K.prototype,"invoke",null),K);function K(){return null!==F&&F.apply(this,arguments)||this}var L,Q=(e(X,L=b),X.prototype.httpRequest=function(s){return d(this,void 0,void 0,function(){var e,r,n,i,o,a;return O(this,function(t){switch(t.label){case 0:return e=s.body,r=s.params,n=s.headers,i=s.path,o=s.method,a=s.exts,[4,this.innerRequest({path:i,headers:n,body:e,queryString:r,method:o,options:a})];case 1:return[2,t.sent()]}})})},X.prototype.innerRequest=function(e){return d(this,void 0,void 0,function(){return O(this,function(t){switch(t.label){case 0:return[4,this.request.exec({env:this.options.env||"online",url:"cloudHttp",data:e},f.GATEWAY)];case 1:return[2,t.sent()]}})})},r([i()],X.prototype,"httpRequest",null),X);function X(){return null!==L&&L.apply(this,arguments)||this}var $,V=(e(Z,$=Error),Z.prototype.toString=function(){return(this.code||"")+" "+(this.message||"")},Z);function Z(){return null!==$&&$.apply(this,arguments)||this}var tt,et=(e(rt,tt=m),rt.getMtopErrorMsg=function(t){var e=new V;if(!t)return e.code="500",e.message="mtop请求错误",e;var r,n,i=t.ret&&t.ret[0]&&t.ret[0].split("::");return t.data=t.data||M(t,["err","data"]),t.data&&t.data.errCode&&(r=t.data.errCode,n=t.data.errMessage||t.data.errMsg),t.data&&t.data.errorCode&&(r=t.data.errorCode),t.data&&t.data.errorMessage&&(n=t.data.errorMessage),t.data&&t.data.success||i&&"SUCCESS"===i[0]&&!r?void 0:(r=r||(i&&"FAIL_SYS_SESSION_EXPIRED"===i[0]?"904":"500"),n=n||i&&i[1]||"mtop请求错误",e.code=r,e.message=n,e)},rt.GATEWAY_APIS={"db/miniapp.cloud.db.collection.create":"mtop.taobao.dataproxy.collection.create","db/miniapp.cloud.db.index.create":"mtop.taobao.dataproxy.index.create","db/miniapp.cloud.db.collection.aggregate":"mtop.taobao.dataproxy.record.aggregate","db/miniapp.cloud.db.collection.count":"mtop.taobao.dataproxy.record.count","db/miniapp.cloud.db.collection.remove":"mtop.taobao.dataproxy.record.delete","db/miniapp.cloud.db.collection.get":"mtop.taobao.dataproxy.record.select","db/miniapp.cloud.db.collection.replace":"mtop.taobao.dataproxy.record.replace","db/miniapp.cloud.db.collection.add":"mtop.taobao.dataproxy.record.insert","db/miniapp.cloud.db.collection.addMany":"mtop.taobao.dataproxy.record.batch.insert","db/miniapp.cloud.db.collection.update":"mtop.taobao.dataproxy.record.update",fc:"mtop.miniapp.cloud.invoke.fc",top:"mtop.miniapp.cloud.invoke.top",qimen:"mtop.miniapp.cloud.invoke.qimen.cloud",process:"mtop.miniapp.cloud.invoke.process",cloudHttp:"mtop.miniapp.cloud.application.request"},rt);function rt(){var t=null!==tt&&tt.apply(this,arguments)||this;return t.sendMtop=function(o,a,s){return d(t,void 0,void 0,function(){return O(this,function(t){return console.log("sendMtop",a),[2,new Promise(function(r,n){var e=1,i=function(){my.sendMtop(p(p({api:o,v:"1.0",data:a,method:"POST"},s),{success:function(t){console.log("mtop success",t);var e=rt.getMtopErrorMsg(t);e?n(e):r(t)},fail:function(t){if(console.log("mtop error",t),1===t.error_type&&0<e)return e-=1,i();n(rt.getMtopErrorMsg(t))}}))};i()})]})})},t.invokeMyApi=function(r,n){return d(t,void 0,void 0,function(){return O(this,function(t){return[2,new Promise(function(t,e){r=r.replace(/^my\./,""),my[r](p(p({},n),{success:t,fail:e}))})]})})},t.sendHttpRequest=function(n,i,o,a){return d(t,void 0,void 0,function(){var e=this;return O(this,function(t){return[2,new Promise(function(r,t){my.httpRequest({url:e.options.gatewayUrl+"/"+n,data:i,dataType:"text",method:a,headers:o,success:function(e){try{r(p(p({},e),{data:JSON.parse(e.data)}))}catch(t){r(p(p({},e),{data:e.data}))}},fail:t})})]})})},t.apply=function(u,l){return d(t,void 0,void 0,function(){var e,r,n,i,o,a,s,c;return O(this,function(t){switch(t.label){case 0:return e=u.url,r=u.data,n=u.headers,i=u.mtopOptions,o=u.method,l!==f.MTOP?[3,2]:[4,this.sendMtop(e,r,i)];case 1:return[2,t.sent()];case 2:return l!==f.GATEWAY?[3,8]:this.options.gatewayUrl?[4,this.sendHttpRequest(e,r,n,o)]:[3,4];case 3:return[2,t.sent()];case 4:return t.trys.push([4,6,,7]),u.rawData&&Object.keys(u.rawData).forEach(function(t){"object"==typeof u.rawData[t]&&(u.rawData[t]=JSON.stringify(u.rawData[t]))}),[4,this.sendMtop(rt.GATEWAY_APIS[e],p(p({},u.rawData),{protocols:JSON.stringify(n)}),i)];case 5:return a=t.sent(),(s=a&&a.data||{}).errCode?[2,{headers:{"mc-code":s.errCode,"mc-msg":s.errMessage},data:{}}]:[2,{headers:{"mc-code":200,"mc-msg":"请求成功"},data:M(s,["data"])||{}}];case 6:return(c=t.sent())&&c.code?[2,{headers:{"mc-code":c.code,"mc-msg":c.message}}]:[2,{headers:{"mc-code":500,"mc-msg":c.message||c}}];case 7:return[3,10];case 8:return[4,this.invokeMyApi(e,r)];case 9:return[2,t.sent()];case 10:return[2]}})})},t}var nt=(it.prototype.init=function(i,o){return d(this,void 0,void 0,function(){var e,r,n;return O(this,function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),e=function(t){return"string"==typeof(t=t||"online")?{database:t,file:t,function:t,message:t}:(t.database=t.database||"online",t.file=t.file||"online",t.function=t.function||"online",t.message=t.message||"online",t)}(i.env),r=new g,this.db=new D({env:e.database},r),this.function=new A({env:e.function},r),this.file=new S({env:e.file},r),this.qimenApi=new J({env:e.database},r),this.topApi=new G({env:e.database},r),this.processApi=new W({env:e.database},r),this.application=new Q({env:e.database},r),[4,r.init(p({},i),o||new et({gatewayUrl:i.__gatewayUrl}))];case 1:return t.sent(),[2,!0];case 2:return n=t.sent(),console.error("SDK初始化失败 ",n),[3,3];case 3:return[2,!1]}})})},it);function it(){}var ot=new nt;t.Cloud=nt,t.default=ot,Object.defineProperty(t,"__esModule",{value:!0})});
